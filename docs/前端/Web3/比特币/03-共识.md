# 共识协议


比特币网络是完全公开的，任何人都可以匿名接入，因此共识协议的稳定性和防攻击性十分关键。

> 共识协议（Consensus Protocol）是分布式系统和区块链中的一种机制，用于在多个节点之间达成一致意见。


<!-- 用于比特币中，是为了解决以下问题：
- **谁来发行货币？**
- **如何验证交易有效？**
- **如何防止双花攻击？** -->

## PoW 
Proof of Work 工作量证明，是通过计算来猜测一个数值（nonce），使得拼凑上交易数据后内容的 Hash 值满足规定的上限（来源于 hashcash）。由于 Hash 难题在目前计算模型下需要大量的计算，这就保证在一段时间内，系统中只能出现少数合法提案。反过来，如果谁能够提出合法提案，也证明提案者确实已经付出了一定的工作量。


同时，这些少量的合法提案会在网络中进行广播，收到的用户进行验证后，会基于用户认为的最长链基础上继续难题的计算。因此，系统中可能出现链的分叉（Fork），但最终会有一条链成为最长的链。


## PoS（Proof of Stake）权益证明
<!-- 权益证明是一种基于权益证明的共识协议，其基本思路是，每个节点持有一定数量的比特币，当某个节点发现有人试图对其进行双花攻击时，他会将自己的币权出售，其他节点会接受该节点的出价，并将其加入到下一个区块中。由于每个节点都有一定数量的币，因此，系统中总会出现一个拥有绝大多数币的节点，从而形成一个稳定的链。 -->



<!-- ## 比特币系统安全性分析 -->

<!-- 1. **可否"偷币"？**（恶意节点能不能将其他账户上比特币转给自己？）  
   不能。因为转账交易需要签名，恶意节点无法伪造他人签名。加入其获得记账权并硬往区块中写入该交易，大多数用户会认为其是一个非法区块，大多数算力将不认可该区块，从而沿着其他路径挖矿，随着时间推移，拥有大多数算力的诚实的节点将会仍然沿着原来区块挖矿，从而形成一条“最长合法链”，该区块变成孤儿区块。对于攻击者来说，不仅不能偷到其他人的比特币，而且得不到出块奖励，还浪费了挖矿花费的电费等成本。 -->
<!-- 2. 可否将已经花过的币再花一遍？
   如下图 1，若 M 已经将钱转给 B，现在想再转给自己，假设其获得记账权，若按照图 1 方式，很明显为一个非法区块，不会被其他节点承认。
   所以，M 只能选择图 2 方式，将 M 转账给 B 的记录回滚掉。这样就有了两条等长合法链，取决于哪一个会胜出。（如果上面交易产生不可逆的外部效果，下面交易回滚便又拿回钱，从而不当获益） -->




<!-- ### 比特币系统安全性分析

1. 可否"偷币"？（恶意节点能不能将其他账户上比特币转给自己？）
   答案：不能。因为转账交易需要签名，恶意节点无法伪造他人签名。加入其获得记账权并硬往区块中写入该交易，大多数用户会认为其是一个非法区块，大多数算力将不认可该区块，从而沿着其他路径挖矿，随着时间推移，拥有大多数算力的诚实的节点将会仍然沿着原来区块挖矿，从而形成一条“最长合法链”，该区块变成孤儿区块。对于攻击者来说，不仅不能偷到其他人的比特币，而且得不到出块奖励，还浪费了挖矿花费的电费等成本。
2. 可否将已经花过的币再花一遍？
   如下图 1，若 M 已经将钱转给 B，现在想再转给自己，假设其获得记账权，若按照图 1 方式，很明显为一个非法区块，不会被其他节点承认。
   所以，M 只能选择图 2 方式，将 M 转账给 B 的记录回滚掉。这样就有了两条等长合法链，取决于哪一个会胜出。（如果上面交易产生不可逆的外部效果，下面交易回滚便又拿回钱，从而不当获益）

![image.png](./img/DfQlwsxN1xYOno5E/1719306994522-31859996-3bff-4f4e-9a96-bf9719ac7348-121587.png)

- 如何防范这种攻击？？？
  如果再 M->B 这个交易之后还延续有几个区块，如下图所示，则大多数诚实节点不会承认下面的链。所以，便变成了恶意节点挖下面的链，其他节点挖上面的链的算力比拼。由于区块链中大多数节点为善意节点，则最终上面链会胜出，而恶意节点的链会不被认可，从而导致投入成本白费。
- 所以，一种简单防范防范便是多等几个确认区块。比特币协议中，缺省需要等 6 个确认区块，此时才认为该记录是不可篡改的。平均出块时间 10min，六个确认区块便需要 1 小时，可见等待时间还是相对较长的。

3. 可否故意不包含合法交易？
   可以，但是可以等待后续区块包含，所以问题不大。实际运行中，可能由于某段时间实际交易数太多，而一个区块包含交易数存在最大值，导致某些合法交易并未被写入区块链（等待后续区块写入）。
4. selfish mining
   提前挖到但不发布，继续挖下去，等到想要攻击的交易等了 6 次确认认为安全之后将整条链发布出去，试图回滚原来记录。这种情况，需要恶意节点掌握系统中半数以上算力才行，否则无法成为最长合法链。

![image.png](./img/DfQlwsxN1xYOno5E/1718285206114-e40a9df1-26c9-4435-bc7d-1d91e1d8fdfd-480375.png)

![image.png](./img/DfQlwsxN1xYOno5E/1719306351535-67b30072-21e2-4df1-9518-2dcc6e7796bc-486869.png)
selfish mining -->
